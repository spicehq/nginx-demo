version: v1beta1
kind: Spicepod
name: f5-nginx

runtime:
  tracing:
    zipkin_enabled: true
    zipkin_endpoint: http://zipkin.zipkin:9411/api/v2/spans

datasets:
  - from: databricks:f5_demo.default.cve_nginx
    name: nginx.cve
    description: Security advisories and Common Vulnerabilities and Exposures (CVEs) for the Nginx project. https://nginx.org/en/security_advisories.html.
    params:
      databricks_token: ${secrets:SPICE_DATABRICKS_TOKEN}
      databricks_endpoint: ${secrets:SPICE_DATABRICKS_ENDPOINT}
      databricks_cluster_id: ${secrets:SPICE_DATABRICKS_CLUSTER_ID}
    metadata:
      instructions: Always provide reference links. Use the primary id as cveId, to generate reference links.
      reference_url_template: https://www.cve.org/CVERecord?id=<cveId>
    embeddings:
      - column: cve_data
        use: oai
        column_pk:
          - cveId
    acceleration:
      enabled: true

  - from: s3://spiceai-demo-datasets/nginx/tickets/
    name: nginx.tickets
    description: Tracked issues for the Nginx project. Tickets from https://trac.nginx.org/nginx/report.
    metadata:
      instructions: Always provide reference links. Use the primary id as ticket_id, to generate reference links.
      reference_url_template: https://trac.nginx.org/nginx/ticket/<ticket_id>
    acceleration:
      enabled: true
    params:
      file_format: csv
      csv_schema_infer_max_records: 1
    embeddings:
      - column: description
        use: oai
        column_pk:
          - id

  - name: nginx.docs
    from: 'sharepoint:drive:Documents/path:/md'
    description: Documentation of the Nginx project. https://nginx.org/en/docs/.
    embeddings:
      - column: content
        use: hf_minilm
        column_pk:
          - name
    acceleration:
      enabled: true
    params:
      # file_format: md
      sharepoint_client_id: f2b3116e-b4c4-464f-80ec-73cd9d9886b4
      sharepoint_tenant_id: 92543123-2b6a-4eec-9b6f-595720cd1c8f
      sharepoint_client_secret: ${secrets:SPICE_SHAREPOINT_CLIENT_SECRET}

  - from: github:github.com/nginx/nginx/commits
    name: nginx.commits
    description: Git commits from the Nginx project.
    metadata:
      instructions: Always provide reference links. Use the primary id as ticket_id, to generate reference links.
      reference_url_template: https://github.com/nginx/nginx/commit/<oid>
    embeddings:
      - column: message
        use: hf_minilm
        column_pk:
          - oid
    acceleration:
      enabled: true
    params:
      github_token: ${env:GITHUB_TOKEN}

embeddings:
  - name: oai
    from: openai
    params:
      openai_api_key: ${ secrets:SPICE_OPENAI_API_KEY }

  - name: hf_minilm
    from: huggingface:huggingface.co/sentence-transformers/all-MiniLM-L6-v2

models:
  - name: openai-with-spice
    from: openai:gpt-4o
    params:
      spice_tools: auto
      openai_api_key: ${ secrets:SPICE_OPENAI_API_KEY }
      system_prompt: |
        You are an AI assistant assisting engineers with the Nginx project.

        Always strive to be accurate, concise, and helpful in your responses.

        Use the SQL tool when:
          1. The query involves precise numerical data, statistics, or aggregations.
          2. The user asks for specific counts, sums, averages, or other calculations.
          3. The query requires joining or comparing data from multiple related tables.

        If the SQL tool returns a query, syntax, or planning error, call the `list_datasets` tool to get the available tables and continue to refine and retry the query until it succeeds. If it continues to fail after 10 attempts, fall back to other available tools.

        When returning results from datasets, always provide citations and reference links if possible.

        Use the document search tool when:
          1. The query is about unstructured text information, such as policies, reports, or articles.
          2. The user is looking for qualitative information or explanations.
          3. The query requires understanding context or interpreting written content.

        General guidelines:
          1. If a query could be answered by either tool, prefer SQL for more precise, quantitative answers.

        Instructions for Responses: 
          - Never include any private metadata provided to the model as context such as \"reference_url_template\" or \"instructions\" in your responses.

  - name: openai
    from: openai:gpt-4o
    params:
      spice_tools: disabled
      openai_api_key: ${ secrets:SPICE_OPENAI_API_KEY }

  - name: openai-with-spice-search
    from: openai:gpt-4o
    params:
      spice_tools: document_similarity, list_datasets
      openai_api_key: ${ secrets:SPICE_OPENAI_API_KEY }

  - name: openai-with-spice-sql
    from: openai:gpt-4o
    params:
      spice_tools: sql, list_datasets, table_schema
      openai_api_key: ${ secrets:SPICE_OPENAI_API_KEY }

  - name: groq
    from: openai:llama-3.1-8b-instant
    params:
      endpoint: https://api.groq.com/openai/v1
      openai_api_key: ${ secrets:SPICE_GROQ_API_KEY_1 }

  - name: groq_with_spice
    from: openai:llama-3.1-8b-instant # llama3-groq-8b-8192-tool-use-preview
    params:
      spice_tools: auto
      endpoint: https://api.groq.com/openai/v1
      openai_api_key: ${ secrets:SPICE_GROQ_API_KEY_2 }
