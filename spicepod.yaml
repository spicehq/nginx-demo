version: v1beta1
kind: Spicepod
name: f5-nginx

datasets:
 - from: s3://spiceai-demo-datasets/nginx/nginx_cve.csv
   name: nginx.cve
   description: Security advisories and Common Vulnerabilities and Exposures (CVEs) for the Nginx project. https://nginx.org/en/security_advisories.html.
   embeddings:
     - column: description
       use: oai
   acceleration:
     enabled: true  

 - from: s3://spiceai-demo-datasets/nginx/tickets/sample/
   name: nginx.tickets
   description: Tracked issues for the Nginx project. Tickets supported from https://trac.nginx.org/nginx/ticket/<id>.
   acceleration:
     enabled: true
   params:
     file_format: csv
     csv_schema_infer_max_records: 1
   embeddings:
     - column: description
       use: oai

 - from: s3://spiceai-demo-datasets/nginx/docs/
   name: nginx.docs
   description: Documentation of the Nginx project. https://nginx.org/en/docs/.
   embeddings:
     - column: content
       use: hf_minilm
       column_pk:
         - location
   acceleration:
     enabled: true
   params:
     file_format: md

 - from: graphql:https://api.github.com/graphql
   name: nginx.commits
   description: Git commits from the Nginx project. Oids are from https://github.com/nginx/nginx/commit/<oid>.
   embeddings:
     - column: message
       use: hf_minilm
   acceleration:
     enabled: true
   params:
     unnest_depth: 1
     graphql_auth_token: ${env:GITHUB_TOKEN}
     json_pointer: /data/repository/defaultBranchRef/target/history/nodes
     #, after: $cursor) { 
     graphql_query: |
        {
          repository(owner: "nginx", name: "nginx") {
            defaultBranchRef {
              target {
                ... on Commit {
                  history(first: 100) { 
                    pageInfo {
                      hasNextPage
                      endCursor
                    }
                    nodes {
                      message
                      messageHeadline
                      messageBody
                      oid
                      additions
                      deletions
                      id
                      committedDate
                      committerName: committer {
                        name
                      }
                      committerEmail: committer {
                        email
                      }
                    }
                  }
                }
              }
            }
          }
        }

embeddings:
  - name: oai
    from: openai
    params:
      openai_api_key: ${ secrets:SPICE_OPENAI_API_KEY }

  - name: hf_minilm
    from: huggingface:huggingface.co/sentence-transformers/all-MiniLM-L6-v2

models:
  - name: openai
    from: openai/gpt-4o
    params:
      spice_tools: disabled
      openai_api_key: ${ secrets:SPICE_OPENAI_API_KEY }

  - name: openai-with-spice
    from: openai/gpt-4o
    params:
      spice_tools: auto
      openai_api_key: ${ secrets:SPICE_OPENAI_API_KEY }      

  - name: openai-with-spice-search
    from: openai/gpt-4o
    params:
      spice_tools: document_similarity, list_datasets
      openai_api_key: ${ secrets:SPICE_OPENAI_API_KEY }

  - name: openai-with-spice-sql
    from: openai/gpt-4o
    params:
      spice_tools: sql, list_tables, table_schema
      openai_api_key: ${ secrets:SPICE_OPENAI_API_KEY }

  - name: groq
    from: openai/llama-3.1-8b-instant
    params:
      endpoint: https://api.groq.com/openai/v1
      openai_api_key: ${ secrets:SPICE_GROQ_API_KEY_1 }

  - name: groq2
    from: openai/llama-3.1-8b-instant
    params:
      endpoint: https://api.groq.com/openai/v1
      openai_api_key: ${ secrets:SPICE_GROQ_API_KEY_2 }
