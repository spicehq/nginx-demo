version: v1beta1
kind: Spicepod
name: f5-nginx

datasets:
 - from: s3://spiceai-demo-datasets/nginx/nginx_cve.csv
   name: nginx_cve
   embeddings:
     - column: description
       use: oai
   acceleration:
     enabled: true

 - from: s3://spiceai-demo-datasets/nginx/tickets/sample/
   name: nginx_tickets
   acceleration:
     enabled: true
   params:
     file_format: csv
     csv_schema_infer_max_records: 1
   embeddings:
     - column: description
       use: oai

 - from: s3://spiceai-demo-datasets/nginx/docs/
   name: nginx_docs
   embeddings:
     - column: content
       use: hf_minilm
       column_pk:
         - location
   acceleration:
     enabled: true
   params:
     file_format: md

 - from: graphql:https://api.github.com/graphql
   name: nginx_commits
   embeddings:
     - column: message
       use: hf_minilm
   acceleration:
     enabled: true
     engine: postgres
     params:
      # neon db
      host: ep-silent-sun-a4ma5q8t.us-east-1.aws.neon.tech
      pg_db: spice-demo-db
      pg_port: 5432
      pg_user: spice-demo-db_owner
      pg_sslmode: require
      pg_pass: ${ env:NEON_POSTGRES_PASSWORD }
      # supabase
      # pg_host: aws-0-us-west-1.pooler.supabase.com
      # pg_db: postgres
      # pg_port: 5432
      # pg_user: 'postgres.tjtwkekeblroqgenheef'
      # pg_sslmode: require
      # pg_pass: ${ env:POSTGRES_PASSWORD }
   params:
     unnest_depth: 1
     graphql_auth_token: ${env:GITHUB_TOKEN}
     json_pointer: /data/repository/defaultBranchRef/target/history/nodes
     #, after: $cursor) {
     graphql_query: |
        {
          repository(owner: "nginx", name: "nginx") {
            defaultBranchRef {
              target {
                ... on Commit {
                  history(first: 100) {
                    pageInfo {
                      hasNextPage
                      endCursor
                    }
                    nodes {
                      message
                      messageHeadline
                      messageBody
                      oid
                      additions
                      deletions
                      id
                      committedDate
                      committerName: committer {
                        name
                      }
                      committerEmail: committer {
                        email
                      }
                    }
                  }
                }
              }
            }
          }
        }

embeddings:
  - name: oai
    from: openai
    params:
      openai_api_key: ${ secrets:SPICE_OPENAI_API_KEY }

  - name: hf_minilm
    from: huggingface:huggingface.co/sentence-transformers/all-MiniLM-L6-v2

models:
  - name: openai
    from: openai/gpt-4o
    params:
      openai_api_key: ${ secrets:SPICE_OPENAI_API_KEY }

  - name: groq
    from: openai/llama-3.1-8b-instant
    params:
      endpoint: https://api.groq.com/openai/v1
      openai_api_key: ${ secrets:SPICE_GROQ_API_KEY_1 }

  - name: groq2
    from: openai/llama-3.1-8b-instant
    params:
      endpoint: https://api.groq.com/openai/v1
      openai_api_key: ${ secrets:SPICE_GROQ_API_KEY_2 }
