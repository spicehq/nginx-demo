version: v1beta1
kind: Spicepod
name: f5-nginx

runtime:
  tracing:
    zipkin_enabled: true
    zipkin_endpoint: http://zipkin.zipkin:9411/api/v2/spans

datasets:
  - from: databricks:f5_demo.default.cve_nginx
    name: nginx.cve
    description: Security advisories and Common Vulnerabilities and Exposures (CVEs) for the Nginx project. https://nginx.org/en/security_advisories.html.
    params:
      databricks_token: ${secrets:SPICE_DATABRICKS_TOKEN}
      databricks_endpoint: ${secrets:SPICE_DATABRICKS_ENDPOINT}
      databricks_cluster_id: ${secrets:SPICE_DATABRICKS_CLUSTER_ID}
    metadata:
      instructions: Always provide reference links. Use the primary id as cveId, to generate reference links.
      reference_url_template: https://www.cve.org/CVERecord?id=<cveId>
    embeddings:
      - column: cve_data
        use: oai
        column_pk:
          - cveId
    acceleration:
      enabled: true

  - from: s3://spiceai-demo-datasets/nginx/tickets/
    name: nginx.tickets
    description: Tracked issues for the Nginx project. Tickets from https://trac.nginx.org/nginx/report.
    metadata:
      instructions: Always provide reference links. Use the primary id as ticket_id, to generate reference links.
      reference_url_template: https://trac.nginx.org/nginx/ticket/<ticket_id>
    acceleration:
      enabled: true
    params:
      file_format: csv
      csv_schema_infer_max_records: 1
    embeddings:
      - column: description
        use: oai
        column_pk:
          - id

  - from: ftp://ftp.spiceai.us/nginx/docs/
    name: nginx.docs
    description: Documentation of the Nginx project. https://nginx.org/en/docs/.
    embeddings:
      - column: content
        use: hf_minilm
        column_pk:
          - location
    acceleration:
      enabled: true
    params:
      file_format: md
      ftp_user: spiceai
      ftp_pass: ${secrets:SPICE_FTP_PASS}

  - from: graphql:https://api.github.com/graphql
    name: nginx.commits
    description: Git commits from the Nginx project.
    metadata:
      instructions: Always provide reference links. Use the primary id as ticket_id, to generate reference links.
      reference_url_template: https://github.com/nginx/nginx/commit/<oid>
    embeddings:
      - column: message
        use: hf_minilm
        column_pk:
          - oid
    acceleration:
      enabled: true
    params:
      unnest_depth: 1
      graphql_auth_token: ${env:GITHUB_TOKEN}
      json_pointer: /data/repository/defaultBranchRef/target/history/nodes
      #, after: $cursor) {
      graphql_query: |
        {
          repository(owner: "nginx", name: "nginx") {
            defaultBranchRef {
              target {
                ... on Commit {
                  history(first: 100) {
                    pageInfo {
                      hasNextPage
                      endCursor
                    }
                    nodes {
                      message
                      messageHeadline
                      messageBody
                      oid
                      additions
                      deletions
                      id
                      committedDate
                      committerName: committer {
                        name
                      }
                      committerEmail: committer {
                        email
                      }
                    }
                  }
                }
              }
            }
          }
        }

embeddings:
  - name: oai
    from: openai
    params:
      openai_api_key: ${ secrets:SPICE_OPENAI_API_KEY }

  - name: hf_minilm
    from: huggingface:huggingface.co/sentence-transformers/all-MiniLM-L6-v2

models:
  - name: openai-with-spice
    from: openai/gpt-4o
    params:
      spice_tools: auto
      openai_api_key: ${ secrets:SPICE_OPENAI_API_KEY }

  - name: openai
    from: openai/gpt-4o
    params:
      spice_tools: disabled
      openai_api_key: ${ secrets:SPICE_OPENAI_API_KEY }

  - name: openai-with-spice-search
    from: openai/gpt-4o
    params:
      spice_tools: document_similarity, list_datasets
      openai_api_key: ${ secrets:SPICE_OPENAI_API_KEY }

  - name: openai-with-spice-sql
    from: openai/gpt-4o
    params:
      spice_tools: sql, list_tables, table_schema
      openai_api_key: ${ secrets:SPICE_OPENAI_API_KEY }

  - name: groq
    from: openai/llama-3.1-8b-instant
    params:
      endpoint: https://api.groq.com/openai/v1
      openai_api_key: ${ secrets:SPICE_GROQ_API_KEY_1 }

  - name: groq_with_spice
    from: openai/llama3-groq-8b-8192-tool-use-preview
    params:
      spice_tools: auto
      endpoint: https://api.groq.com/openai/v1
      openai_api_key: ${ secrets:SPICE_GROQ_API_KEY_2 }
